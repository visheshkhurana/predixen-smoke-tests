# Git Pipeline for AI Development (Replit-Safe)

## Branch Naming Convention
\`ai/<task-id>-<short-desc>\`
Example: \`ai/TASK-SPR-001-001-add-health-endpoint\`

## GitHub API Endpoints Used

### 1. Create Branch
POST https://api.github.com/repos/{owner}/{repo}/git/refs
Body: { "ref": "refs/heads/ai/TASK-SPR-001-001-desc", "sha": "<main-branch-sha>" }

### 2. Get Main Branch SHA
GET https://api.github.com/repos/{owner}/{repo}/git/ref/heads/main

### 3. Commit Files to Branch
PUT https://api.github.com/repos/{owner}/{repo}/contents/{path}
Body: { "message": "feat(TASK-SPR-001-001): description", "content": "<base64>", "branch": "ai/TASK-SPR-001-001-desc", "sha": "<file-sha-if-exists>" }

### 4. Create Pull Request (optional, for audit trail)
POST https://api.github.com/repos/{owner}/{repo}/pulls
Body: { "title": "[AI] TASK-SPR-001-001: description", "head": "ai/TASK-SPR-001-001-desc", "base": "main", "body": "Auto-generated by AI Engineering pipeline" }

### 5. Merge Branch to Main
POST https://api.github.com/repos/{owner}/{repo}/merges
Body: { "base": "main", "head": "ai/TASK-SPR-001-001-desc", "commit_message": "merge(TASK-SPR-001-001): description" }

### 6. Delete Branch After Merge
DELETE https://api.github.com/repos/{owner}/{repo}/git/refs/heads/ai/TASK-SPR-001-001-desc

## Merge Conflict Resolution
1. If merge fails with 409 Conflict:
   - Fetch latest main
   - Re-run BACKEND_ENGINEER_AGENT with updated file contents
   - Re-run QA + Data checks
   - Retry merge

## Rollback Procedure
1. Identify merge commit SHA from audit log
2. POST /repos/{owner}/{repo}/git/refs/heads/main with previous SHA
3. Force-push reverts the merge
4. Log rollback event to governance system

## Approval Gate Logic
| Risk Level | QA Pass | Data Pass | CTO Approve | Founder Approve | Auto-Merge? |
|-----------|---------|-----------|-------------|-----------------|-------------|
| low       | YES     | YES       | YES         | -               | YES         |
| medium    | YES     | YES       | YES         | -               | YES         |
| high      | YES     | YES       | YES         | YES             | NO          |
| critical  | YES     | YES       | YES         | YES             | NO          |
